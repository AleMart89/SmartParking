<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Evitar cachÃ© -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>EcoSmartParking - Cliente</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOwKGDxFFltqhS8r9oKnLH2nKCvAFAddU",
  authDomain: "ecosmartparking-f637a.firebaseapp.com",
  projectId: "ecosmartparking-f637a",
  storageBucket: "ecosmartparking-f637a.firebasestorage.app",
  messagingSenderId: "659680232018",
  appId: "1:659680232018:web:2ecc9a36040d4cdd47958b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let ticketId = null;
let timer = null;
window.metodoPago = null; // Guardar mÃ©todo de pago globalmente

/* ----------------- UTIL ----------------- */
function $(id){ return document.getElementById(id); }
function show(section){
  document.querySelectorAll(".screen").forEach(div=>div.classList.add("hidden"));
  $(section).classList.remove("hidden");
}
function generateQR(el, text){
  el.innerHTML = "";
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const size = isMobile ? 300 : 180;
  new QRCode(el, { text, width: size, height: size });
}

/* ----------------- GENERAR TICKET ----------------- */
$("btnStart").onclick = async ()=>{
  ticketId = "T-" + Math.random().toString(36).substring(2) + "-" + Date.now();

  await setDoc(doc(db,"parkingTickets",ticketId),{
    status:"pending_entry",
    createdAt: serverTimestamp()
  });

  localStorage.setItem("currentTicket", ticketId);
  generateQR($("qrEntry"), ticketId);
  show("screenEntryQR");

  watchTicket(ticketId);
};

/* ----------------- OBSERVADOR FIRESTORE ----------------- */
function watchTicket(id){
  onSnapshot(doc(db,"parkingTickets",id), d=>{
    if(!d.exists()) return;
    let data = d.data();

    if(data.status === "active"){
      show("screenActive");
      $("startTime").textContent = data.entryTime.toDate().toLocaleTimeString();
      startTimer(data.entryTime);
    }

    if(data.status === "exited"){
      clearInterval(timer);
      $("finalAmount").textContent = data.cost ? data.cost.toFixed(2) : "0.00";
      show("screenThanks");
      localStorage.removeItem("currentTicket");
    }
  });
}

/* ----------------- TIMER ----------------- */
function startTimer(entryTime){
  clearInterval(timer);
  timer = setInterval(()=>{
    let now = new Date();
    let diffMin = Math.floor((now - entryTime.toDate()) / 60000);
    if(diffMin < 1) diffMin = 1;

    let cost = diffMin * 0.03;
    $("timeDisplay").textContent = diffMin + " min";
    $("costDisplay").textContent = "$" + cost.toFixed(2);
  },1000);
}

/* ----------------- PAGOS ----------------- */
// Yappy
$("btnYappy").onclick = async ()=>{
  const numero = prompt("Ingrese su nÃºmero Yappy (celular):");
  if(numero && numero.trim() !== ""){
    try {
      await updateDoc(doc(db, "parkingTickets", ticketId), { yappy: numero.trim(), metodoPago: "Yappy" });
      window.metodoPago = "Yappy";
    } catch (e) {
      console.warn("No se pudo guardar nÃºmero Yappy:", e);
    }
    generateQR($("qrExit"), ticketId);
    show("screenExitQR");
  } else {
    alert("Debe ingresar un nÃºmero Yappy vÃ¡lido.");
  }
};

// Efectivo
$("btnEfectivo").onclick = async ()=>{
  try {
    await updateDoc(doc(db, "parkingTickets", ticketId), { metodoPago: "Efectivo" });
    window.metodoPago = "Efectivo";
  } catch (e) {
    console.warn("No se pudo guardar el mÃ©todo de pago:", e);
  }
  generateQR($("qrExit"), ticketId);
  show("screenExitQR");
};

/* ----------------- RESTAURAR SESIÃ“N ----------------- */
let saved = localStorage.getItem("currentTicket");
if(saved){
  ticketId = saved;
  watchTicket(ticketId);
}


/* ----------------- VER FACTURA ----------------- */
function mostrarFactura(){
  const now = new Date().toLocaleString();
  const metodo = window.metodoPago || "Desconocido";
  const facturaHTML = `
    <p><strong>Ticket:</strong> ${ticketId}</p>
    <p><strong>MÃ©todo de pago:</strong> ${metodo}</p>
    <p><strong>Monto total:</strong> $${$("finalAmount").textContent}</p>
    <p><strong>Fecha:</strong> ${now}</p>
    <p class="mt-2">Contacto: soporte@ecosmartparking.com</p>
  `;
  $("facturaContenido").innerHTML = facturaHTML;
  $("modalFactura").classList.remove("hidden");
}
function cerrarFactura(){
  $("modalFactura").classList.add("hidden");
}
  window.mostrarFactura = mostrarFactura;
  window.cerrarFactura = cerrarFactura;
  
/* ----------------- DESCARGAR FACTURA (CON DISEÃ‘O) ----------------- */
function descargarFactura() {
  const contenido = document.getElementById("facturaContenido").innerHTML;

  const htmlCompleto = `
  <!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura EcoSmartParking</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        padding: 0;
        text-align: center;
        color: #333;
      }
      .logo {
        width: 120px;
        margin-bottom: 10px;
      }
      .contenedor {
        max-width: 400px;
        margin: 0 auto;
        border: 1px solid #ccc;
        padding: 16px;
        border-radius: 8px;
      }
      h2 {
        font-size: 1.4em;
        margin-bottom: 8px;
      }
      p {
        font-size: 1em;
        margin: 6px 0;
      }
      hr {
        margin: 10px 0;
        border: none;
        border-top: 1px solid #ccc;
      }
      .gracias {
        margin-top: 20px;
        font-weight: bold;
        font-size: 1.1em;
      }
    </style>
  </head>
  <body>
    <img src="logoEcoSmartParking.png" alt="EcoSmartParking Logo" class="logo">
    <div class="contenedor">
      <h2>Factura Digital</h2>
      <hr>
      ${contenido}
      <hr>
      <p class="gracias">Â¡Gracias por confiar en nosotros!</p>
    </div>
  </body>
  </html>
  `;

  const blob = new Blob([htmlCompleto], { type: "text/html" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `Factura_${ticketId}.html`;
  link.click();
}

window.descargarFactura = descargarFactura;
</script>
</head>

<body class="bg-lime-100 min-h-screen text-gray-900 flex flex-col items-center">
  <!-- Encabezado -->
  <header class="w-full text-center py-6 bg-white shadow-md border-b border-lime-300">
    <img src="logoEcoSmartParking.png" alt="EcoSmartParking Logo" class="mx-auto w-64 mb-2">
    <h1 class="text-3xl font-bold text-green-700">EcoSmartParking</h1>
  </header>

  <!-- Contenido principal -->
  <main class="flex-grow flex items-center justify-center w-full p-4">
    <div class="bg-yellow-50 shadow-lg rounded-2xl p-6 w-full max-w-lg border border-lime-300 relative">

      <!-- PANTALLA INICIO -->
      <div id="screenStart" class="screen">
        <h1 class="text-center text-2xl font-bold text-green-700">EcoSmartParking</h1>
        <p class="text-center text-gray-600">GestiÃ³n digital del estacionamiento</p>
        <button id="btnStart" class="w-full mt-6 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
          Generar Ticket de Entrada
        </button>
      </div>

      <!-- PANTALLA QR ENTRADA -->
      <div id="screenEntryQR" class="screen hidden text-center">
        <h2 class="text-xl font-semibold mb-2 text-green-700">CÃ³digo QR de Entrada</h2>
        <div id="qrEntry" class="mx-auto"></div>
        <p class="text-gray-600 mt-2">El guardia debe escanear este cÃ³digo</p>
      </div>

      <!-- PANTALLA ACTIVA -->
      <div id="screenActive" class="screen hidden text-center">
        <h2 class="text-xl font-semibold text-green-700">Estacionamiento Activo</h2>
        <p class="text-gray-600">Hora de entrada: <span id="startTime"></span></p>
        <div class="mt-4 text-4xl font-bold text-green-700" id="timeDisplay">--</div>
        <div class="text-3xl text-yellow-600" id="costDisplay">$0.00</div>
        <p class="mt-4 text-gray-700 font-medium">Seleccione su mÃ©todo de pago:</p>
        <div class="flex flex-col gap-3 mt-4">
          <button id="btnYappy" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
            Pagar con Yappy
          </button>
          <button id="btnEfectivo" class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 font-semibold">
            Pagar en Efectivo
          </button>
        </div>
      </div>

      <!-- PANTALLA QR SALIDA -->
      <div id="screenExitQR" class="screen hidden text-center">
        <h2 class="text-xl font-semibold text-green-700">CÃ³digo QR de Salida</h2>
        <div id="qrExit" class="mx-auto"></div>
        <p class="text-gray-600 mt-2">El guardia debe escanear para finalizar</p>
      </div>

      <!-- PANTALLA GRACIAS -->
      <div id="screenThanks" class="screen hidden text-center">
        <h2 class="text-2xl font-semibold text-green-700">Â¡Gracias por tu visita!</h2>
        <p class="text-gray-700">Total Pagado:</p>
        <h3 class="text-3xl font-bold mt-2 text-yellow-600">$<span id="finalAmount">0.00</span></h3>
        <button id="btnVerFactura" onclick="mostrarFactura()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
          Ver factura
        </button>
      </div>

    </div>
  </main>

  <!-- MODAL FACTURA -->
  <div id="modalFactura" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-80 text-center shadow-lg relative">
      <button onclick="cerrarFactura()" class="absolute top-2 right-3 text-gray-500 text-lg">&times;</button>
      <h2 class="text-2xl font-bold text-green-700 mb-2">EcoSmartParking</h2>
      <p class="text-gray-600 mb-4">Factura Digital</p>
      <div id="facturaContenido" class="text-left text-gray-700 text-sm mb-4"></div>
      <p class="text-green-700 font-semibold text-center">Â¡Gracias por confiar en nosotros!</p>
       
      <!-- ðŸ”½ NUEVO BOTÃ“N PARA DESCARGAR FACTURA -->
    <button onclick="descargarFactura()" class="mt-2 bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-green-800">
      Descargar factura
    </button>
    </div>
  </div>
</body>

</html>





